# ACTIONS FLOW

This document is the server-side source of truth for gameplay action flow and equipment interactions.

Scope:

- Covers gameplay action handlers in `packages/server/src/index.ts`
- Covers validation and execution in `packages/server/src/validation.ts`, `packages/server/src/gameLogic.ts`, `packages/server/src/equipment.ts`
- Covers forced-action and mission-hook side effects from `packages/server/src/missionHooks.ts`
- Covers setup token action in `packages/server/src/setupTokenRules.ts`
- Covers mission-22 token-pass resolution in `packages/server/src/mission22TokenPass.ts`

Out of scope:

- Lobby/admin/chat/audio actions (`join`, `selectCharacter`, `chat`, `missionAudioControl`, etc.)
- UI rendering logic (client components)

Terminology:

- `Succeed` means the action is accepted and execution runs. It can still end in mission loss.
- `Blocked` means the action is rejected before execution; server sends an error and returns.

## Global Pipeline

| Item                        | Event   | Exact flow                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| --------------------------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Any gameplay action message | Succeed | 1. `onMessage` parses JSON.<br>2. Spectator gate runs first: if sender is not a player in an active game, reject.<br>3. Routed handler checks game existence and required phase.<br>4. Action-specific validator runs; for cut actions this includes mission hook `validate` dispatch.<br>5. Execution mutates state (may set `pendingForcedAction`, advance turn, end game, etc.).<br>6. Some handlers call `maybeRecordMissionFailure(previousResult, state)` after execution.<br>7. `saveState()` persists room state.<br>8. If handler has an action payload, `broadcastAction(action)` is sent.<br>9. `broadcastGameState()` sends filtered state to players/spectators.<br>10. `scheduleBotTurnIfNeeded()` runs. |
| Any gameplay action message | Blocked | 1. Parse failure: send `"Invalid message format"`.<br>2. Spectator in active game: send `"Spectators cannot perform actions"`.<br>3. Unknown message type: send `"Unknown message type"`.<br>4. Handler-level gates or validator error: send error message (often with legality `code`) and return without execution.                                                                                                                                                                                                                                                                                                                                                                                                  |

## Core Gameplay Actions

| Item                                                              | Event   | Exact flow                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ----------------------------------------------------------------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `placeInfoToken` (setup phase action)                             | Succeed | 1. `handlePlaceInfoToken` checks active game and `phase === "setup_info_tokens"`.<br>2. Enforces setup turn order (`currentPlayerIndex`).<br>3. Checks player exists, required token count, and whether player already completed setup tokens.<br>4. `validateSetupInfoTokenPlacement` enforces mission-specific placement legality.<br>5. Token is built with `applyMissionInfoTokenVariant` and stored via `pushInfoToken` (mission 50 uses stand-side placement, mission 22 uses absent-value rules).<br>6. Mission 22 refreshes board token-pass state.<br>7. Setup log entry is appended.<br>8. `advanceSetupTurnAndMaybeStart` advances setup turn and flips to `phase="playing"` when all placements complete (captain starts turn 1).<br>9. Save + broadcast game state + bot scheduling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `placeInfoToken` (setup phase action)                             | Blocked | 1. No active game, wrong phase, wrong setup turn, or player missing.<br>2. Player not required to place a setup token or already completed placement.<br>3. `validateSetupInfoTokenPlacement` rejection (invalid value/index, duplicate token-on-wire, mission-specific false/absent-value violations, wrong wire class, mismatch with tile value, etc.).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `dualCut`                                                         | Succeed | 1. `validateDualCutWithHooks` runs base legality plus mission-hook `validate`.<br>2. `executeDualCut` computes correctness and whether actor truly has announced value.<br>3. Success branch: cut target tile, dispatch mission-hook `resolve(cutSuccess=true)`, handle hook-forced immediate game end, cut actor matching tile, update validation track and equipment unlocks (or hook override threshold), clear satisfied secondary equipment locks, update board markers, detect detonator loss/win, then `advanceTurn`.<br>4. Validation-track updates can trigger mission-54 oxygen bonus payout when a value crosses from `<4` to `>=4` confirmed cuts.<br>5. Failure branch: dispatch `resolve(cutSuccess=false)` first, then resolve failure outcomes: red/hidden-red explosion rules, mission-14/28 captain fail explosions, upside-down self-cut explosion rule, stabilizer prevention behavior, detonator +1 when applicable, failure info-token placement mode (wire/stand/none), and false-token variants that can place the announced guess value instead of actual wire value.<br>6. If actor has no allowed announced tile in failure path, fallback own-wire cut logic is used before upside-down self-cut explosion checks.<br>7. Returns `dualCutResult` or `gameOver` action payload.<br>8. Handler records failure counters (if newly failed), saves, broadcasts action + state, schedules bot turn.                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `dualCut`                                                         | Blocked | 1. No game / wrong phase.<br>2. Base validation rejection: not your turn, actor/target missing, self-target, invalid/cut tile, invalid guess value, guess value not in actor hand, mission-35 X-wire restrictions, mission-13 red-target special-action requirement.<br>3. Global action gates from `validateActionWithHooks`: forced action pending, forced reveal-reds required (with mission exceptions where force is disabled, including mission-18 designated-cutter sub-turn and missions 26/59), mission-46 pending-sevens restriction.<br>4. Mission hook `validate` rejection (constraints and mission-specific rules).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `dualCutDoubleDetector` (base character personal action)          | Succeed | 1. `validateDualCutDoubleDetectorWithHooks` verifies legality and mission rules.<br>2. `executeDualCutDoubleDetector` marks `characterUsed=true` (except mission 58), checks two designated tiles for blue numeric matches, and always creates `pendingForcedAction.kind="detectorTileChoice"` with hidden match metadata.<br>3. Logs `"waiting for target to confirm"` and returns `dualCutDoubleDetectorResult` with `outcome:"pending"`.<br>4. No cut resolution happens yet; final outcome is produced by `detectorTileChoice` forced-action handler.<br>5. Handler records failure counters if needed, saves, broadcasts pending action + state, schedules bot turn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `dualCutDoubleDetector` (base character personal action)          | Blocked | 1. No game / wrong phase.<br>2. Base DD validation rejection: not your turn, actor/target missing, self-target, non-DD character, ability already used (except mission 58), same tile twice, invalid/out-of-stand/cut tiles, invalid guess value, guess not in hand, constraint G, mission 17/28 captain personal-equipment ban, mission 13 non-blue targeting ban, mission 20/35 X-wire restrictions.<br>3. Global `validateActionWithHooks` rejection (forced action pending, forced reveal-reds, mission-46 pending-sevens, mission hook validation).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `detectorTileChoice` (forced action resolver for DD/Triple/Super) | Succeed | 1. `handleDetectorTileChoice` enforces active game, playing phase, pending detector action exists, and caller is forced target player.<br>2. Validates user choice requirements: if 2+ matches, chosen tile must be one of matches; DD no-match optional info-token override must reference one of original two tiles.<br>3. `resolveDetectorTileChoice` clears pending action and strips `"Waiting for..."` suffix in the prior log entry.<br>4. If 0 matches (or DD actor has no announced value), runs no-match path:<br>5. DD source: `resolveDoubleDetectorNoMatch` handles mission-59 rotation flag, stabilizer-driven detonator behavior, both-red explosion rule, mission-14 intern fail explosion override, and info-token target selection. DD override targeting a red/red-like designated tile is rejected and resolver auto-picks a non-red-like designated tile when possible.<br>6. DD no-match then applies failure token placement mode, detonator-loss check, turn advance, and returns `dualCutDoubleDetectorResult(outcome:"no_match")`.<br>7. Triple/Super source: picks fallback designated tile and delegates to `executeDualCut` (which then runs full dual-cut flow and returns `dualCutResult`/`gameOver`).<br>8. If at least one match: chosen matching tile is cut and mission `resolve` hooks run (hook may end game immediately). Then actor matching tile is cut, validation/equipment unlock bookkeeping runs, and detonator-loss/win checks run (either can return `gameOver` before turn advance). If no end condition triggers, turn advances and result is `dualCutDoubleDetectorResult(outcome:"match")` for DD or `dualCutResult(success:true)` for Triple/Super.<br>9. Handler records mission failure counters when result changed to a failure, saves, broadcasts action + state, schedules bot turn.<br>10. View filtering redacts detector `matchingTileIndices` for non-target clients and additionally redacts `actorTileIndex` for spectators and non-actor bystanders. |
| `detectorTileChoice` (forced action resolver for DD/Triple/Super) | Blocked | 1. No game / wrong phase.<br>2. No pending detector forced action.<br>3. Caller is not forced target player.<br>4. Target player missing.<br>5. Invalid tile choice (multi-match case) or invalid info-token override index (DD no-match case).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `soloCut`                                                         | Succeed | 1. `validateSoloCutWithHooks` validates turn/rules and mission hooks.<br>2. `executeSoloCut` cuts first matching tile, dispatches mission-hook `resolve(cutSuccess=true)`, and short-circuits to `gameOver` if hook ended game.<br>3. Cuts remaining matching tiles in actor hand.<br>4. Updates validation track (numeric), equipment unlocks (with optional hook threshold override), clears secondary equipment locks, updates markers.<br>5. Logs solo-cut detail, checks win, otherwise advances turn and returns `soloCutResult`.<br>6. Handler records mission failure counters if needed, saves, broadcasts action + state, schedules bot turn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `soloCut`                                                         | Blocked | 1. No game / wrong phase.<br>2. Base legality rejection: not your turn, actor missing, no matching wires in hand, mission-35 X restriction, not all remaining copies in hand, invalid pair count (numeric solo requires exactly 2 or 4).<br>3. Global/hook rejection: forced action pending, forced reveal-reds, mission-46 pending-sevens, mission hook validation errors (constraints/mission rules).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `revealReds`                                                      | Succeed | 1. `validateRevealRedsWithHooks` validates forced reveal legality for current mission.<br>2. `executeRevealReds` cuts all actor uncut tiles, updates markers, writes mission-specific log text (mission 11 hidden red-like value), checks win, otherwise advances turn, and returns `revealRedsResult`.<br>3. Handler records failure counters if needed, saves, broadcasts action + state, schedules bot turn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `revealReds`                                                      | Blocked | 1. No game / wrong phase.<br>2. Base legality rejection: not your turn, actor missing, no wires, non-all-red remainder, mission-11 hidden-value mismatch, mission-11 hidden-value setup missing, mission-13 special-action requirement override.<br>3. Global/hook rejection: forced action pending, mission hook validation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `simultaneousRedCut` (missions 13/41/48 special action)           | Succeed | 1. `validateSimultaneousRedCutWithHooks` validates mission availability, turn, target count, target uniqueness, target tile existence/cut state, and mission-specific targeting constraints.<br>2. `executeSimultaneousRedCut` resolves by mission color requirement (`red` in 13, `yellow` in 41/48).<br>3. On mismatch: mission 41 uses one-target branch (red hit explodes; non-red mismatch places info token + detonator +1, then detonator-loss check can return `gameOver(loss_detonator)`), mission 48 places info tokens on designated wires + detonator +1 then checks detonator loss (can return `gameOver(loss_detonator)`), mission 13 mismatch explodes immediately.<br>4. On all-match: cuts all designated wires, mission 41 reduces detonator by 1, updates markers, optionally unlocks yellow equipment, checks win, advances turn, returns `simultaneousRedCutResult`.<br>5. Handler records mission failure counters if needed, saves, broadcasts action + state, schedules bot turn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `simultaneousRedCut` (missions 13/41/48 special action)           | Blocked | 1. No game / wrong phase.<br>2. Base legality rejection: wrong mission, not your turn, actor missing, no available required-color targets, 2-3 player ownership restriction for missions 13/48, wrong target count, duplicate targets, invalid player/index, cut tile, mission 41 self-target ban.<br>3. Global/hook rejection: forced action pending, forced reveal-reds (except allowed simultaneous-reveal override in missions 13/48), mission-46 pending-sevens, mission hook validation errors.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `simultaneousFourCut` (missions 23/39/46 special action)          | Succeed | 1. `validateSimultaneousFourCutWithHooks` validates mission/turn/targets and mission-specific state gates.<br>2. `executeSimultaneousFourCut` resolves target value, clears mission-46 pending-sevens forced state, then checks all 4 designated wires match expected value (mission 46 uses seven-tile matcher).<br>3. Success branch: cuts all 4 targets; for missions 23/39 marks special action complete, mission 39 deals remaining Number cards from captain clockwise with one-token grant rule, and unlocks all face-down equipment; then updates markers/validation/equipment unlocks, checks win, advances turn, and returns `simultaneousFourCutResult(success:true)`.<br>4. Failure branch: immediate `loss_red_wire` with `gameOver` action.<br>5. Handler records mission failure counters if needed, saves, broadcasts action + state, schedules bot turn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `simultaneousFourCut` (missions 23/39/46 special action)          | Blocked | 1. No game / wrong phase.<br>2. Base legality rejection: wrong mission, not your turn, already done (23/39), mission-46 required player mismatch, missing number card in 23/39, wrong target count, duplicate targets, invalid player/index, cut tile.<br>3. Global/hook rejection: forced action pending (except mission-46 forced-sevens allowance for this exact action), forced reveal-reds, mission hook validation errors.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `simultaneousCut` (validation-only internal action type)          | Succeed | 1. Exists in `validation.ts` as an internal `ValidatableAction` kind with full legality checks (`validateSimultaneousCutLegality`) and mission-hook `validate` dispatch support.<br>2. This path validates multi-target announced-value availability in actor hand and target constraints but has no gameplay handler in `index.ts` in current implementation.<br>3. It is a validation surface only unless a runtime route is added in the future.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `simultaneousCut` (validation-only internal action type)          | Blocked | 1. Internal validation rejects same categories as other cut actions: turn/actor/target/index/cut-state errors, self-target/duplicate-target errors, and insufficient announced values in actor hand for requested simultaneous cuts.<br>2. Global/hook rejection from `validateActionWithHooks` still applies (forced action pending, forced reveal-reds, mission-46 pending-sevens, mission hook `validate` errors).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `surrenderVote`                                                   | Succeed | 1. `handleSurrenderVote` requires active game in `setup_info_tokens` or `playing` phase.<br>2. Caller must be a non-bot player in the current game.<br>3. Builds eligible voter set from all human players and normalizes prior yes-votes to eligible IDs.<br>4. Applies caller vote (`vote=true` adds caller; `vote=false` removes caller).<br>5. Stores/clears `surrenderVote.yesVoterIds` based on remaining yes-voters.<br>6. If the callerâ€™s yes/no state changed, appends a game-log entry (`voted to surrender` or `unvoted surrender`) including current yes-vote tally.<br>7. Saves and broadcasts game state only (vote updates never end the mission directly).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `surrenderVote`                                                   | Blocked | 1. No active game.<br>2. Phase is not `setup_info_tokens` or `playing` (includes finished game).<br>3. Caller is not a player in the current game or is a bot.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `confirmSurrender`                                                | Succeed | 1. `handleConfirmSurrender` requires active game in `setup_info_tokens` or `playing` phase.<br>2. Caller must be a non-bot player in the current game.<br>3. Rebuilds eligible human player set and normalizes current yes-voters to eligible IDs.<br>4. Computes majority threshold `floor(eligiblePlayers/2)+1` and requires current yes-voters to meet it.<br>5. On threshold met: sets `phase="finished"` and `result="loss_surrender"`, clears `pendingForcedAction` and `surrenderVote`, records mission-failure counter transition, logs confirmation detail, saves, broadcasts `gameOver(loss_surrender)`, then broadcasts game state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `confirmSurrender`                                                | Blocked | 1. No active game.<br>2. Phase is not `setup_info_tokens` or `playing` (includes finished game).<br>3. Caller is not a player in the current game or is a bot.<br>4. Current yes-votes are below majority threshold.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

## Forced Mission Control Actions

| Item                                           | Event   | Exact flow                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------------------------------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `chooseNextPlayer` (mission 10 forced action)  | Succeed | 1. Handler requires active game in playing phase.<br>2. Requires `pendingForcedAction.kind === "chooseNextPlayer"` and caller is forced captain.<br>3. Validates target exists and still has uncut wires.<br>4. Applies no-consecutive-turn restriction check (`isRepeatNextPlayerSelectionDisallowed`).<br>5. Clears pending action, sets `currentPlayerIndex` to target, saves, broadcasts game state, schedules bot turn.                                                                                                                                                                                                         |
| `chooseNextPlayer` (mission 10 forced action)  | Blocked | 1. No game / wrong phase.<br>2. No pending choose-next action.<br>3. Caller not forced captain.<br>4. Target not found or has no remaining wires.<br>5. Mission no-consecutive rule violation.                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `designateCutter` (mission 18 forced action)   | Succeed | 1. Handler requires active game in playing phase.<br>2. Requires `pendingForcedAction.kind === "designateCutter"` and caller is forced designator.<br>3. Validates target exists, has uncut wires, and satisfies mission-18 radar requirement (`validateMission18DesignatedCutterTarget`).<br>4. Saves designator index in campaign (`mission18DesignatorIndex`), transfers turn to target cutter, clears pending action, logs selection, saves, broadcasts state, schedules bot turn.                                                                                                                                               |
| `designateCutter` (mission 18 forced action)   | Blocked | 1. No game / wrong phase.<br>2. No pending designate-cutter action.<br>3. Caller not designator.<br>4. Target not found / no uncut wires.<br>5. Mission-18 radar requirement failed.                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `mission22TokenPassChoice`                     | Succeed | 1. Handler requires active game in playing phase.<br>2. Requires `pendingForcedAction.kind === "mission22TokenPass"` and caller is current chooser.<br>3. Validates chosen token value is integer `0..12`.<br>4. `applyMission22TokenPassChoice` consumes board token supply and gives token to clockwise recipient.<br>5. Recipient token placement tries matching uncut wire; if none found, token position becomes `-2` so value is consumed anyway.<br>6. Logs token pass hook detail.<br>7. Advances forced-action chain to next chooser or clears when chain complete.<br>8. Saves, broadcasts game state, schedules bot turn. |
| `mission22TokenPassChoice`                     | Blocked | 1. No game / wrong phase.<br>2. No pending mission-22 token-pass action.<br>3. Caller is not current chooser.<br>4. Value outside `0..12`.<br>5. Token not available on board supply or recipient invalid (apply function returns failure).                                                                                                                                                                                                                                                                                                                                                                                          |
| `talkiesWalkiesChoice` (forced tile selection) | Succeed | 1. Handler requires active game in playing phase.<br>2. Requires `pendingForcedAction.kind === "talkiesWalkiesTileChoice"` and caller is target teammate.<br>3. Validates chosen teammate tile exists, is uncut, and is not mission-restricted X wire.<br>4. `resolveTalkiesWalkiesTileChoice` performs swap/token-transfer/remap, clears pending action, logs source (`useEquipment` or `characterAbility`), returns `equipmentUsed` action.<br>5. Saves, broadcasts action + state, schedules bot turn.                                                                                                                            |
| `talkiesWalkiesChoice` (forced tile selection) | Blocked | 1. No game / wrong phase.<br>2. No pending walkie-talkies choice.<br>3. Caller not forced target teammate.<br>4. Target player not found.<br>5. Invalid tile index, cut tile, or mission X-wire restriction.                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `mission61ConstraintRotate`                    | Succeed | 1. Handler requires active game in playing phase.<br>2. Requires `pendingForcedAction.kind === "mission61ConstraintRotate"` and caller is forced captain.<br>3. If `direction === "skip"`, logs skip event.<br>4. Else rotates active global constraint via `rotateMission61Constraint` and logs direction.<br>5. Clears pending action.<br>6. Runs `resolveMission61AfterConstraintDecision` which may auto-skip unplayable players and can end mission in `loss_detonator` if the round stalls.<br>7. Saves and broadcasts game state, schedules bot turn.                                                                         |
| `mission61ConstraintRotate`                    | Blocked | 1. No game / wrong phase.<br>2. No pending mission-61 rotate action.<br>3. Caller not forced captain.<br>4. Rotation attempt fails due to missing active/deck constraint state.                                                                                                                                                                                                                                                                                                                                                                                                                                                      |

## Equipment Action Gateway

| Item                         | Event   | Exact flow                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ---------------------------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `useEquipment` (common flow) | Succeed | 1. Handler requires active game and playing phase.<br>2. `validateUseEquipment` passes all common gates and card-specific payload checks.<br>3. `executeUseEquipment` marks the card `used=true` first, then executes card effect.<br>4. Handler records mission failure counters if result changed to new failure.<br>5. Saves, broadcasts returned action payload, broadcasts game state, schedules bot turn.<br>6. Returned action type depends on card: usually `equipmentUsed`, but `x_or_y_ray` returns `dualCutResult`/`gameOver`.                                                                                                                                                                                                                             |
| `useEquipment` (common flow) | Blocked | Common gates before card-specific checks:<br>1. Pending forced action exists.<br>2. Actor missing.<br>3. Mission-46 pending-sevens player restriction.<br>4. Mission-41 forced skip turn restriction.<br>5. Forced reveal-reds restriction (applies only when actor is current turn player).<br>6. Constraint G (`no equipment / no personal equipment`).<br>7. Mission 17 captain ban, mission 28 captain ban, mission 14 captain stabilizer ban.<br>8. Mission 18 manual `general_radar` use ban and mission-18 cutter-subturn equipment ban.<br>9. Card not found, face-down, locked, secondary lock unsatisfied, already used, payload-kind mismatch.<br>10. Timing violation from card definition (`in_turn`, `start_of_turn`, duplicate stabilizer activation).<br>11. Card-specific payload validation failure. |

## Equipment Cards

| Item                  | Event   | Exact flow                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| --------------------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `label_neq`           | Succeed | 1. Common `useEquipment` gates pass.<br>2. Card validation enforces adjacent same-stand indices with non-equal values and not both cut; mission restrictions (58/no tokens, upside-down no-equipment target, X-wire ignore) are enforced.<br>3. Execution pushes relation token `{ relation:"neq", position, positionB }` to actor info tokens.<br>4. Logs usage and returns `equipmentUsed(effect:"label_neq")`.                                                                                                                                                                                                                                                                               |
| `label_neq`           | Blocked | 1. Any common equipment block reason.<br>2. Mission 58 no-token rule.<br>3. Invalid indices, non-adjacent indices, equal-value pair, or both wires already cut.<br>4. Upside-down own-wire restriction or mission X-wire restriction.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `talkies_walkies`     | Succeed | 1. Common gates pass.<br>2. Validation checks teammate exists/not self; actor tile valid+uncut+allowed; teammate has at least one swappable uncut wire.<br>3. Execution always sets `pendingForcedAction.kind="talkiesWalkiesTileChoice"` and returns `equipmentUsed(effect:"talkies_walkies_pending")`.<br>4. Target teammate later resolves `talkiesWalkiesChoice`; resolver runs `swapTalkiesWires`, transfers single-position tokens with wires (mission 24 discards `countHint` tokens on swapped wire), re-sorts each stand by `sortValue`, remaps token indices, logs, and returns `equipmentUsed(effect:"talkies_walkies")`. |
| `talkies_walkies`     | Blocked | 1. Any common equipment block reason.<br>2. Teammate missing/self-target.<br>3. Invalid/cut actor tile or mission restriction on actor tile.<br>4. Teammate has no swappable uncut tile (after mission restrictions). |
| `triple_detector`     | Succeed | 1. Common gates pass.<br>2. Validation enforces target exists/not self, numeric guess `1..12`, actor has guess value, exactly 3 unique target wires on same stand, each tile uncut and mission-allowed.<br>3. Validation pre-checks mission legality by simulating `validateDualCutWithHooks` using deterministic fallback target selection.<br>4. Execution creates `pendingForcedAction.kind="detectorTileChoice"` with source `tripleDetector` and hidden match indices, logs waiting message, returns `equipmentUsed(effect:"triple_detector_pending")`.<br>5. Final cut outcome resolves later through `detectorTileChoice`.                                                               |
| `triple_detector`     | Blocked | 1. Any common equipment block reason.<br>2. Invalid target/guess, actor missing guess value, wrong tile count/duplicates, non-same-stand selection, invalid/cut/mission-disallowed target tile, mission-hook dual-cut rejection on fallback tile.                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `post_it`             | Succeed | 1. Common gates pass.<br>2. Validation enforces actor-owned target tile, blue numeric requirement, no existing value-class token on tile, mission allowances for cut-tile targeting (only missions 24/40), plus no-token missions/constraints checks.<br>3. Execution places mission-variant info token via `pushInfoToken(applyMissionInfoTokenVariant(...))`, logs, returns `equipmentUsed(effect:"post_it")`.                                                                                                                                                                                                                                                                                |
| `post_it`             | Blocked | 1. Any common equipment block reason.<br>2. Constraint H or mission 58 no-token mode.<br>3. Invalid index, cut tile (unless mission 24/40), non-blue/non-numeric tile, tile already has value-class info token, upside-down own-wire restriction, mission X-wire restriction.                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `super_detector`      | Succeed | 1. Common gates pass.<br>2. Validation enforces target exists/not self, guess `1..12`, actor has guess value, and valid stand selection (explicit for multi-stand target players).<br>3. Eligible target set is computed from the stand (uncut, mission-allowed, non-X when restricted).<br>4. Validation runs `validateDualCutWithHooks` using fallback target chosen from eligible set.<br>5. Execution creates `pendingForcedAction.kind="detectorTileChoice"` with source `superDetector`, logs waiting message, returns `equipmentUsed(effect:"super_detector_pending")`.<br>6. Final cut outcome resolves later through `detectorTileChoice`.                                             |
| `super_detector`      | Blocked | 1. Any common equipment block reason.<br>2. Invalid target/guess, actor missing guess value, missing/invalid stand index for multi-stand target, no eligible uncut wires on stand, mission-disallowed targeting, or mission-hook dual-cut rejection on fallback tile.                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `rewinder`            | Succeed | 1. Common gates pass.<br>2. Execution sets detonator to `max(0, detonator-1)`, logs moved/unchanged detail, returns `equipmentUsed(effect:"rewinder")`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `rewinder`            | Blocked | 1. Any common equipment block reason (no card-specific payload checks).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `emergency_batteries` | Succeed | 1. Common gates pass.<br>2. Validation requires one or two unique target players and each target must already have `characterUsed=true`.<br>3. Execution sets selected playersâ€™ `characterUsed=false`, logs count, returns `equipmentUsed(effect:"emergency_batteries")`.                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `emergency_batteries` | Blocked | 1. Any common equipment block reason.<br>2. Invalid target list size (`<1` or `>2` unique IDs), missing player, or target without used character ability.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `general_radar`       | Succeed | 1. Common gates pass.<br>2. Validation requires value `1..12`.<br>3. Execution computes per-player yes/no by stand for uncut blue wires of that value (X wires ignored when restriction is active), logs full detail string, returns `equipmentUsed(effect:"general_radar")`.                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `general_radar`       | Blocked | 1. Any common equipment block reason.<br>2. Invalid radar value.<br>3. Mission 18 always blocks manual general-radar card use.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `stabilizer`          | Succeed | 1. Common gates pass and timing must be start-of-turn for current player.<br>2. Execution writes `turnEffects.stabilizer = { playerId, turnNumber }`, logs usage, returns `equipmentUsed(effect:"stabilizer")`.<br>3. Effect is consumed by dual-cut failure handling and expires when turn advances (`advanceTurn` clears `turnEffects`).                                                                                                                                                                                                                                                                                                                                                      |
| `stabilizer`          | Blocked | 1. Any common equipment block reason.<br>2. Timing violation (not your turn for start-of-turn use).<br>3. Stabilizer already active this turn.<br>4. Mission 14 captain-specific stabilizer ban.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `x_or_y_ray`          | Succeed | 1. Common gates pass.<br>2. Validation enforces target exists/not self, target tile valid/uncut/mission-allowed, two distinct announced values, numeric ranges for numeric guesses, and actor must hold both announced values.<br>3. Effective guess is resolved against target tile (`A` if no match).<br>4. Validation invokes `validateDualCutWithHooks` with effective guess.<br>5. Execution logs the announced-value pair, then delegates to `executeDualCut` with display label `A/B`; returned action is `dualCutResult` or `gameOver` (not `equipmentUsed`). |
| `x_or_y_ray`          | Blocked | 1. Any common equipment block reason.<br>2. Invalid target/indices, cut tile, mission-disallowed tile class, duplicate announced values, out-of-range numeric guess, or actor missing either announced value.<br>3. Mission-hook dual-cut rejection on effective guess path.                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `coffee_mug`          | Succeed | 1. Common gates pass and timing requires actor turn.<br>2. Validation enforces target exists, target is not actor, and target has uncut wires.<br>3. Execution logs pass-turn template and calls `setNextPlayerFromCoffee`.<br>4. `setNextPlayerFromCoffee` clears turn effects, sets turn to target player, increments turn number, dispatches mission `endTurn` hooks (which can override the next player or create forced actions).<br>5. Returns `equipmentUsed(effect:"coffee_mug")`.                                                                                                                                                                                                      |
| `coffee_mug`          | Blocked | 1. Any common equipment block reason.<br>2. Timing violation (not actor turn).<br>3. Missing target, self-target, or target with no remaining wires.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `label_eq`            | Succeed | 1. Common gates pass.<br>2. Validation enforces adjacent same-stand indices whose values are equal by implemented comparator (`red==red`, `yellow==yellow`, or equal blue numeric values).<br>3. Execution adds relation token `{ relation:"eq", position, positionB }`, logs, returns `equipmentUsed(effect:"label_eq")`.                                                                                                                                                                                                                                                                                                                                                                      |
| `label_eq`            | Blocked | 1. Any common equipment block reason.<br>2. Mission 58 no-token rule.<br>3. Invalid indices, non-adjacent pair, or non-equal pair.<br>4. Upside-down own-wire restriction or mission X-wire restriction.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `false_bottom`        | Succeed | 1. Common gates pass.<br>2. Validation requires non-empty campaign equipment reserve.<br>3. Execution draws up to two cards from reserve and inserts into board equipment list.<br>4. Each drawn card auto-unlocks immediately if current cut count already meets its unlock threshold (`2` default, `4` for double-number campaign cards).<br>5. Logs drawn card names and returns `equipmentUsed(effect:"false_bottom")`.                                                                                                                                                                                                                                                                     |
| `false_bottom`        | Blocked | 1. Any common equipment block reason.<br>2. Empty/missing equipment reserve.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `single_wire_label`   | Succeed | 1. Common gates pass.<br>2. Validation enforces actor tile exists, is blue numeric, and is mission-allowed.<br>3. Implemented uniqueness check counts blue value occurrences across actorâ€™s full hand (cut + uncut); must equal exactly 1.<br>4. Validation rejects if same tile already has a `singleWire` token.<br>5. Execution adds `{ singleWire:true }` token on tile, logs, returns `equipmentUsed(effect:"single_wire_label")`.                                                                                                                                                                                                                                                         |
| `single_wire_label`   | Blocked | 1. Any common equipment block reason.<br>2. Mission 58 no-token mode.<br>3. Invalid index, non-blue/non-numeric tile, value-occurrence not exactly one in actor hand, duplicate single-wire label, upside-down own-wire restriction, mission X-wire restriction.                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `emergency_drop`      | Succeed | 1. Common gates pass.<br>2. Validation requires at least one other used equipment card on board.<br>3. Execution sets `used=false` for all used equipment except itself, logs restored count, returns `equipmentUsed(effect:"emergency_drop")`.                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `emergency_drop`      | Blocked | 1. Any common equipment block reason.<br>2. No other used equipment to restore.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `fast_pass`           | Succeed | 1. Common gates pass and timing requires actor turn.<br>2. Validation requires numeric value `1..12` and at least two uncut matching wires in actor hand.<br>3. Execution cuts first matching tile, dispatches mission `resolve` hook as solo-cut success, and short-circuits if hook ends game.<br>4. Cuts second tile, updates validation track and equipment unlocks (hook threshold override possible), clears secondary locks, updates markers.<br>5. Checks detonator-loss from hook side effects; logs result.<br>6. Checks win, otherwise advances turn.<br>7. Returns `equipmentUsed(effect:"fast_pass")` or `gameOver`.                                                               |
| `fast_pass`           | Blocked | 1. Any common equipment block reason.<br>2. Invalid numeric value or fewer than two uncut matching actor wires.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `disintegrator`       | Succeed | 1. Common gates pass.<br>2. Execution draws random value `1..12`.<br>3. Finds all uncut blue wires of that value across all players.<br>4. Cuts those wires one-by-one; after each cut dispatches mission `resolve` hook as solo-cut success with running cut count.<br>5. If hook ends game mid-loop, stops immediately and returns `gameOver`.<br>6. Otherwise updates validation track, equipment unlocks (with hook override support), clears secondary locks, updates markers.<br>7. Checks detonator-loss from hook side effects and win condition (either can return `gameOver`).<br>8. If no end condition triggers, returns `equipmentUsed(effect:"disintegrator")` (no turn advance). |
| `disintegrator`       | Blocked | 1. Any common equipment block reason (card has no extra payload checks).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `grappling_hook`      | Succeed | 1. Common gates pass.<br>2. Validation enforces valid teammate target, uncut target tile, mission-allowed tile class, and (for two-stand actor) required valid `receiverStandIndex`.<br>3. Execution removes target wire from teammate hand and decrements target stand size.<br>4. Removes info tokens attached to that removed wire and reindexes remaining teammate token positions.<br>5. Inserts taken wire into the chosen receiving stand in `sortValue` order, increments actor stand size for that stand, and reindexes actor token positions at/after insertion point.<br>6. Logs source + destination placement and returns `equipmentUsed(effect:"grappling_hook")` (no turn advance). |
| `grappling_hook`      | Blocked | 1. Any common equipment block reason.<br>2. Missing target, self-target, invalid index, cut target wire, mission-disallowed target class (yellow special missions, X-wire restrictions).<br>3. Two-stand actor omitted/invalid `receiverStandIndex`. |

## Character Ability Gateway and Expert Abilities

| Item                                          | Event   | Exact flow                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| --------------------------------------------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `useCharacterAbility` (common flow for E1-E4) | Succeed | 1. Handler requires active game and playing phase.<br>2. `validateCharacterAbility` passes common gates + ability-specific payload checks.<br>3. `executeCharacterAbility` marks `characterUsed=true` (except mission 58), executes mapped ability logic, and returns action payload.<br>4. Handler records mission failure counters if newly failed, saves, broadcasts action + state, schedules bot turn.<br>5. `character_e1..e4` map to `general_radar`, `talkies_walkies`, `triple_detector`, `x_or_y_ray`. |
| `useCharacterAbility` (common flow for E1-E4) | Blocked | 1. Pending forced action, actor missing, mission-46 pending-sevens, mission-41 skip-turn, forced reveal-reds while actor is current turn player, constraint G.<br>2. Wrong character type (base DD characters cannot use this endpoint), payload kind mismatch for character, already-used ability (except mission 58), mission 17/28 captain bans.<br>3. Timing violation for in-turn abilities (`triple_detector`, `x_or_y_ray`).<br>4. Ability-specific payload validation failure.                                                              |
| `character_e1 -> general_radar`               | Succeed | 1. Ability validation checks value `1..12`.<br>2. Execution computes and logs per-player per-stand yes/no detail (same as equipment radar).<br>3. Returns `equipmentUsed(equipmentId:"general_radar", effect:"general_radar")`.                                                                                                                                                                                                                                                                                  |
| `character_e1 -> general_radar`               | Blocked | 1. Any common character-ability block reason.<br>2. Invalid radar value.                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `character_e2 -> talkies_walkies`             | Succeed | 1. Same payload validation and pending-flow semantics as equipment `talkies_walkies`.<br>2. Execution always sets pending forced action `talkiesWalkiesTileChoice` with source `characterAbility` and returns `equipmentUsed(effect:"talkies_walkies_pending")`.<br>3. Final swap resolves when teammate submits `talkiesWalkiesChoice`. |
| `character_e2 -> talkies_walkies`             | Blocked | 1. Any common character-ability block reason.<br>2. Same payload rejection conditions as equipment talkies-walkies path.                                                                                                                                                                                                                                                                                                                                                                                         |
| `character_e3 -> triple_detector`             | Succeed | 1. Same validation semantics as equipment `triple_detector`.<br>2. Execution sets pending detector choice (`source:"tripleDetector"`, no equipment ID), logs waiting, returns `equipmentUsed(effect:"triple_detector_pending")`.<br>3. Final cut outcome resolves via `detectorTileChoice`.                                                                                                                                                                                                                      |
| `character_e3 -> triple_detector`             | Blocked | 1. Any common character-ability block reason.<br>2. Same triple-detector payload and mission-hook rejection conditions as equipment path.                                                                                                                                                                                                                                                                                                                                                                        |
| `character_e4 -> x_or_y_ray`                  | Succeed | 1. Same validation semantics as equipment `x_or_y_ray`.<br>2. Execution logs both announced values, resolves effective guess value, then delegates to `executeDualCut`.<br>3. Returned action is `dualCutResult`/`gameOver` (not `equipmentUsed`).                                                                                                                                                                                                                                                               |
| `character_e4 -> x_or_y_ray`                  | Blocked | 1. Any common character-ability block reason.<br>2. Same X-or-Y payload and mission-hook rejection conditions as equipment path.                                                                                                                                                                                                                                                                                                                                                                                 |

## Notes For Future Fixes

1. Do not bypass validators; all gameplay state transitions rely on these gatekeepers for legality.
2. `dispatchHooks` ordering is mission-schema order; later hook results override earlier ones except first validation error.
3. `advanceTurn` clears turn-scoped effects (including stabilizer), skips players with no uncut wires, and auto-wins when all players are empty.
4. Validation-track updates can have side effects beyond progress: mission 54 oxygen bonus payout is triggered on threshold crossing (`<4` to `>=4`).
5. Some â€œsuccessful acceptanceâ€ branches intentionally end in mission loss (`gameOver`) by design.
6. Forced actions are hard blockers for normal actions until resolved, except the mission-46 forced simultaneous-four-cut allowance.
