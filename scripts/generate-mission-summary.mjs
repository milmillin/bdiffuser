#!/usr/bin/env node
import { readFileSync, writeFileSync } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, "..");
const schemaPath = path.join(rootDir, "packages/shared/src/missionSchema.ts");
const outPath = path.join(rootDir, "packages/shared/MISSION_SUMMARY_GENERATED.md");

function defaultDifficulty(id) {
  if (id <= 3) return "novice";
  if (id <= 7) return "intermediate";
  if (id === 8) return "expert";
  return "campaign";
}

function parseMissionBlocks(source) {
  const blockRegex = /setMission\((\d+),\s*\{([\s\S]*?)\n\}\);/g;
  const missions = [];

  for (const match of source.matchAll(blockRegex)) {
    const id = Number(match[1]);
    const body = match[2];

    const nameMatch = body.match(/name:\s*"([^"]+)"/);
    const difficultyMatch = body.match(/difficulty:\s*"([^"]+)"/);
    const allowedMatch = body.match(/allowedPlayerCounts:\s*\[([^\]]*)\]/);
    const hooksMatch = body.match(/behaviorHooks:\s*\[([\s\S]*?)\]/);

    const hooks = hooksMatch
      ? hooksMatch[1]
        .split(",")
        .map((part) => part.trim())
        .filter((part) => part.startsWith("\"") && part.endsWith("\""))
        .map((part) => part.slice(1, -1))
      : [];

    const allowedPlayerCounts = allowedMatch
      ? allowedMatch[1]
        .split(",")
        .map((part) => part.trim())
        .filter((part) => part.length > 0)
        .join(", ")
      : "2, 3, 4, 5";

    missions.push({
      id,
      name: nameMatch ? nameMatch[1] : `Mission ${id}`,
      difficulty: difficultyMatch ? difficultyMatch[1] : defaultDifficulty(id),
      behaviorHooks: hooks,
      allowedPlayerCounts,
    });
  }

  return missions.sort((a, b) => a.id - b.id);
}

function renderMarkdown(missions) {
  const generatedAt = new Date().toISOString();
  const lines = [];

  lines.push("# Mission Summary (Generated)");
  lines.push("");
  lines.push(`Generated from \`packages/shared/src/missionSchema.ts\` on \`${generatedAt}\`.`);
  lines.push("Do not edit this file manually; re-run `pnpm mission:summary`.");
  lines.push("");
  lines.push(`Total missions: ${missions.length}`);
  lines.push("");
  lines.push("| ID | Name | Difficulty | Allowed Players | Hook Count | Hooks |");
  lines.push("|---:|------|------------|-----------------|-----------:|-------|");

  for (const mission of missions) {
    const hooksText =
      mission.behaviorHooks.length > 0 ? mission.behaviorHooks.join(", ") : "â€”";
    lines.push(
      `| ${mission.id} | ${mission.name} | ${mission.difficulty} | ${mission.allowedPlayerCounts} | ${mission.behaviorHooks.length} | ${hooksText} |`,
    );
  }

  lines.push("");
  return lines.join("\n");
}

const source = readFileSync(schemaPath, "utf8");
const missions = parseMissionBlocks(source);
const markdown = renderMarkdown(missions);
writeFileSync(outPath, markdown, "utf8");

console.log(`Wrote ${outPath} (${missions.length} missions)`);
